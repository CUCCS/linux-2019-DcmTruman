# WEB服务器

## 实验环境

Ubuntu 18.04LTS

## 拓扑结构

![](images/topu.png)

## 安装配置步骤

先执行以下更新操作，我的虚拟机里有apache2，为了防止影响，先用`sudo apt purge`和`sudo apt autoremove`卸载掉apache2

### Nginx

nginx的安装比较简单

```bash
# 安装nginx
sudo apt-get install nginx -y
# 验证是否安装成功
sudo nginx -t
```
访问80端口，界面如下

![](images/start_nginx.png)


### VeryNginx

```bash 
# nginx安装完成之后会自动启动，我们先关掉
sudo nginx -s stop
# 安装所需程序
sudo apt install -y libpcre3-dev libssl1.0-dev zlib1g-dev python3 unzip gcc make
# 下载并解压verynginx安装包
wget https://github.com/alexazhou/VeryNginx/archive/master.zip
unzip master.zip
cd VeryNginx-master/
#修改nginx.conf , 将第二行的user设置为www-data
sed -i "2s/nginx/www-data/" nginx.conf
#安装verynginx
sudo python3 install.py install
#安装完之后，每次启动verynginx都要执行/opt/verynginx/openresty/nginx/sbin/nginx
#这里学习'MasterofMagic'，创建软链接
sudo ln -s /opt/verynginx/openresty/nginx/sbin/nginx /usr/sbin/verynginx
#检查配置是否ok，如果可以，显示的结果如下
# nginx: the configuration file /opt/verynginx/openresty/nginx/conf/nginx.conf syntax is ok
# nginx: configuration file /opt/verynginx/openresty/nginx/conf/nginx.conf test is successful
#启动verynginx
sudo verynginx
```

此时verynginx已经安装成功，在宿主机上访问80端口，显示同verynginx，如下

![](images/verynginx_start.png)

访问verynginx配置界面，`vn.sec.cuc.edu.cn/verynginx/index.html`账号如下

```
username=verynginx
password=verynginx
```
登录成功，界面如下

![](images/success_login.png)

### WordPress

```bash
# WordPress需要用到数据库，所以我们要用mysql创建WordPress所需要的库
# 下载安装mysql和php7.2相关软件
sudo apt install -y mysql-server php7.2-fpm php7.2-mysql php7.2-gd
# 安装完成后进入root用户
# mysql root 用户默认没有密码
sudo mysql -u root -p
# 进入mysql后之后，创建WordPress使用的数据库

mysql> CREATE USER 'wordpress'@'localhost' IDENTIFIED BY 'wordpress';
mysql> CREATE DATABASE wp_db;
mysql> GRANT ALL ON wp_db.* TO 'wordpress'@'localhost';
# 指定WorePress目录
WP_PATH=/var/www/wordpress
# 创建该目录下的public文件夹
sudo mkdir -p ${WP_PATH}/public/
# 修改该文件下的所有者为www-data
sudo chown -R www-data:www-data ${WP_PATH}/public
# 下载并解压WorePress
wget https://wordpress.org/wordpress-4.7.zip
unzip wordpress-4.7.zip
# 将wordpress文件全部拷贝刚才的public中
sudo cp -r wordpress/* ${WP_PATH}/public/
cd ${WP_PATH}/public/
# 拷贝配置文件
sudo cp wp-config-sample.php wp-config.php
# 修改wp-config.php文件中的`database_name_here`,`username_here`和`password_here`字段为我们的数据库名称，用户名和密码。使wordpress能够访问mysql。
sudo sed -i s/database_name_here/wp_db/ wp-config.php
sudo sed -i s/username_here/wordpress/ wp-config.php
sudo sed -i s/password_here/wordpress/ wp-config.php
```

### 连接WordPress与Nginx

```bash
# 新建配置文件，设置端口8080和文件名wp.sec.cuc.edu.cn
WP_DOMAIN=wp.sec.cuc.edu.cn
WP_PORT=8080
sudo tee /etc/nginx/sites-available/${WP_DOMAIN} << EOF
server {
    listen localhost:${WP_PORT};
    server_name ${WP_DOMAIN};

    root ${WP_PATH}/public;
    index index.php;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.2-fpm.sock;
    }
}
EOF
# 在sites-enabled中创建sites-available的软链接，并删除default
sudo ln -s /etc/nginx/sites-available/${WP_DOMAIN} /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
# 启动nginx
sudo nginx
```

### 配置VeryNginx访问wp.sec.cuc.edu.cn

添加匹配规则

![](images/wordpress_match.png)

添加Up Stream节点

![](images/UpStream_node.png)

添加Proxy Pass规则

![](images/proxy_rule.png)

保存（最下方）

![](images/save.png)

然后访问`wp.sec.cuc.edu.cn`就可以自动进入安装界面了，安装过程中可以设置博客Tittle，用户名，密码，邮箱等

![](images/install.png)

安装完成后，进入管理页面，简易的楚盟网WordPress博客到这也就配置好了

![](images/admin_wordpress.png)

![](images/main_wordpress.png)

### 安装Dvwa并配置VeryNginx

与WordPress步骤类似

```bash
# 指定目录，更改所有者
DVWA_PATH=/var/www/dvwa
sudo mkdir -p ${DVWA_PATH}/public/
sudo chown -R www-data:www-data ${DVWA_PATH}/public

# 下载解压
wget https://github.com/ethicalhack3r/DVWA/archive/master.zip
unzip master.zip
# 拷贝文件到/var/www/dvwa下
sudo cp -r DVWA-master/* ${DVWA_PATH}/public/
cd ${DVWA_PATH}/public/
sudo cp config/config.inc.php.dist config/config.inc.php
# 配置文件,8000端口
DVWA_DOMAIN=dvwa.sec.cuc.edu.cn
DVWA_PORT=8000
sudo tee /etc/nginx/sites-available/${DVWA_DOMAIN} << EOF
server {
    listen localhost:${DVWA_PORT};
    server_name ${DVWA_DOMAIN};

    root ${DVWA_PATH}/public;
    index index.php;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.2-fpm.sock;
    }
}
EOF
# 设置软链接
sudo ln -s /etc/nginx/sites-available/${DVWA_DOMAIN} /etc/nginx/sites-enabled/
# 重新载入配置
sudo nginx -s reload
```

添加匹配规则

![](images/match_dvwa.png)

添加Up Stream节点

![](images/upstream_dvwa.png)

添加Proxy Pass 规则

![](images/prexy_rule_dvwa.png)

保存后访问`dvwa.sec.cuc.edu.cn`就能看到如下页面了

![](images/main_dvwa.png)

### WordPress启用HTTPS

本实验中，localhost网站使用的证书和verynginx对外使用的证书，我使用的是tsyitc

```bash
# 生成自签名证书
sudo openssl req -x509 -newkey rsa:4096 -nodes -subj "/C=CN/ST=Beijing/L=Beijing/O=CUC/OU=SEC/CN=wp.sec.cuc.edu.cn" -keyout key.pem -out cert.pem -days 365
# 将生成的cert.pem和key.pem放在/etc/nginx目录下
sudo mv cert.pem /etc/nginx/
sudo mv key.pem /etc/nginx/
# 修改/etc/nginx/sites-available/wp.sec.cuc.edu.cn 中的8080端口为”8443 ssl"
sudo sed -i "2s/8080/8443\ ssl" wp.sec.cuc.edu.cn
# 在第二行后添加cert.pem和key.pem
sudo sed -i '2a ssl_certificate      /etc/nginx/cert.pem;\nssl_certificate_key  /etc/nginx/key.pem;' wp.sec.cuc.edu.cn
```

在`/opt/verynginx/openresty/nginx/conf/nginx.conf`中修改server块，使verynginx监听443端口

```bash
server {
    listen 80;
    listen 443 ssl;
    ssl_certificate      /etc/nginx/cert.pem;
    ssl_certificate_key  /etc/nginx/key.pem;

    #this line shoud be include in every server block
    include /opt/verynginx/verynginx/nginx_conf/in_server_block.conf;

    location = / {
        root   html;
        index  index.html index.htm;
    }
}
```
重新加载配置文件

```bash
sudo nginx -s reload
sudo verynginx -s reload
```

由于刚才改了nginx对wordpress的配置文件，所以要重新去verynginx中设置一下

![](images/wordpress_ssl1.png)

保存好之后再访问，就发现可以访问https啦！因为此时还没有对verynginx访问强制限制https，所以`http://wp.sec.cuc.cn`和`https://wp.sec.cuc.cn`均可以访问，只是VeryNginx在访问Nginx时使用的https

![](images/https_wp.png)

在Scheme Lock添加规则并勾选Enable，就可以强制访问https了

![](images/scheme_enable.png)


## 安全加固

### 使用IP地址方式均无法访问上述任意站点，并向访客展示自定义的友好错误提示信息页面-1


添加`Matcher`规则

![](images/ip_match.png)

添加`Response`相应

![](images/ip_response.png)

添加`Filter`

![](images/ip_filter.png)

此时以ip形式访问，会出现对应的提示并拒绝

![](images/ip_refuse.png)


### Damn Vulnerable Web Application (DVWA)只允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-2

添加`Matcher`

![](images/white_match.png)

添加`Response`

![](images/white_response.png)

添加`Filter`

![](images/white_filter.png)

在白名单的客户端访问

![](images/is_white.png)

不在白名单的客户端访问

![](images/is_not_white.png)


### 在不升级Wordpress版本的情况下，通过定制VeryNginx的访问控制策略规则，热修复WordPress < 4.7.1 - Username Enumeration

在Permalink Settings中设置Day and name

![](images/day_name.png)

访问页面`wp.sec.cuc.edu.cn/wp-json/wp/v2/users/`可以看到用户信息

![](images/user_info.png)

添加`^/wp-json/wp/v2/users.*`匹配和filter，拒绝即可

![](images/user_match.png)

![](images/user_block.png)

![](images/user_filter.png)


### 通过配置VeryNginx的Filter规则实现对Damn Vulnerable Web Application (DVWA)的SQL注入实验在低安全等级条件下进行防护

我们可以只简单过滤一下提交参数（毕竟低等级）

![](images/sql_easy.png)

![](images/sql_easy_filter.png)

### VeryNginx的Web管理页面仅允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-3

与其他两个类似

添加`Matcher`

![](images/vn_match.png)


![](images/white_vn_match.png)

添加`Response`

![](images/vn_resp.png)

添加`Filter`，顺序很重要

![](images/vn_filter.png)

白名单访问

![](images/vn_white.png)

非白名单访问

![](images/nwhite_vn.png)








### 限制DVWA站点的单IP访问速率为每秒请求数 < 50, 限制Wordpress站点的单IP访问速率为每秒请求数 < 20, 超过访问频率限制的请求直接返回自定义错误提示信息页面-4

添加`Response`

![](images/fre_resp.png)

添加`Frequency Limit`

![](images/fre_limit.png)

进行压测，可以看到，用时两秒，100次访问60次都失败了

![](images/ab.png)








